---
title: 公共脚本
date: 2024-07-09
permalink: /00-setting/Apifox/czdo8ccr/
---

## 引入测试
::: code-tabs#js

@tab appToken生成

```js
// appToken.js
<!-- @include: ./appToken.js -->
```
@tab:active 登录脚本

```js
// login.js
<!-- @include: ./login.js -->
```
@tab Header设置

```js
// header.js
<!-- @include: ./header.js -->
```

:::




## token生成

> 实现使用Apifox的环境变量实现 多环境、 单词请求多次复用 、 自动过期

```js
function generateAppToken() {
    if (!pm.globals.has("appId")) {
        pm.globals.set("appId", '')
    }
    if (!pm.globals.has("secret")) {
        pm.globals.set("secret", '')
    }
    if (!pm.globals.has("key")) {
        pm.globals.set("key", '')
    }

    const appId = pm.globals.get("appId");
    const secret = pm.globals.get("secret");
    const key = pm.globals.get("key");
    console.log("appToken配置:\n appId: " + appId + "\n secret: " + secret + "\n key: " + key);

    pm.test('全局变量【appToken配置[appId|secret|key]信息】校验', function () {
        pm.expect(appId).to.not.be.empty;
        pm.expect(secret).to.not.be.empty;
        pm.expect(key).to.not.be.empty;
    });

    const jetLag = 0 // 服务器与本机时间差 
    let timestamp = new Date().getTime()
    timestamp += Number(jetLag)
    var cryptoJs = require("crypto-js");
    var h256 = cryptoJs.HmacSHA256(secret + '.' + timestamp, key)
    var btoa = require("btoa");
    var bs6 = btoa(' {"appId":"' + appId + '","timestamp":' + timestamp + '}')
    var appToken = bs6 + "." + h256;
    if ('' != appId && '' != secret && '' != key) {
        pm.environment.set('APP_TOKEN', appToken);
        // 过期时间 向后偏移5分钟
        let expireTime = new Date();
        expireTime.setMinutes(expireTime.getMinutes() + 5);
        pm.environment.set("APP_TOKEN_EXPIRES", expireTime);
        console.log("设置环境变量【appToken】，值为【" + appToken + "】")
    }
    return appToken;
}

const env_appToken = pm.environment.get("APP_TOKEN");
const env_appTokenExpires = pm.environment.get("APP_TOKEN_EXPIRES");

if (!env_appToken || (env_appTokenExpires && new Date(env_appTokenExpires) <= new Date())) {
    generateAppToken();
}
```



## 登录脚本

> 实现使用Apifox的环境变量实现 多环境、不同用户的登录、 单词请求多次复用 、 自动过期

```js
function generateAccessToken() {

    if (!pm.environment.has("ACCESS_TOKEN")) {
        pm.environment.set("ACCESS_TOKEN", null)
    }
    if (!pm.environment.has("ACCESS_TOKEN_EXPIRES")) {
        pm.environment.set("ACCESS_TOKEN_EXPIRES", null)
    }

    if (!pm.environment.has("loginURL")) {
        pm.environment.set("loginURL", 'http://127.0.0.1:8080/login')
    }
    pm.test('环境变量 {loginURL:登录地址}配置校验', function () {
        pm.expect(pm.environment.get("loginURL")).to.not.be.empty;
    });

    if (!pm.environment.has("activeUser")) {
        pm.environment.set("activeUser", 'defaultUser')
    }

    if (!pm.environment.has("defaultUser")) {
        pm.environment.set("defaultUser", '{"username":"19973504813","password":"123456"}')
    }

    const loginUserStr = pm.environment.get("activeUser");
    const loginUser = pm.environment.get(loginUserStr)
    console.log("登录入参：" + loginUser);
    pm.test('环境变量 {activeUser:当前登录用户}【' + loginUserStr + '】', function () {
        pm.expect(loginUser).to.not.be.empty;
    });

    const loginInfo = '' != loginUser ? loginUser : '{"example": "example"}';
    const loginURL = '' != pm.environment.get("loginURL") ? pm.environment.get("loginURL") : 'http://127.0.0.1:8080/example';

    const appToken = pm.environment.get("APP_TOKEN") ?? '';

    const echoPostRequest = {
        url: loginURL,
        method: "POST",
        header: {
            "User-Agent": "	Apifox/1.0.0 (https://apifox.com)",
            "Accept": "	*/*",
            "Content-Type": "application/json",
            "appToken": appToken,
        },
        body: {
            mode: 'raw',
            raw: loginInfo
        }
    };
    console.log("登录请求：" + JSON.stringify(echoPostRequest));

    pm.sendRequest(echoPostRequest, function (err, res) {
        if (err) {
            console.log(err);
        } else {
            const ret = res.json();
            pm.test('登录成功校验', function () {
                pm.expect(res).to.have.property("code", 200);
                pm.expect(ret).to.have.any.keys('accessToken');
            });
            pm.environment.set("ACCESS_TOKEN", ret.accessToken);
            // 过期时间 向后偏移2小时
            let expireTime = new Date();
            expireTime.setHours(expireTime.getHours() + 2);
            pm.environment.set("ACCESS_TOKEN_EXPIRES", expireTime);
            console.log("设置环境变量【accessToken】，值为【" + ret.accessToken + "】")
        }
    });
}

const accessToken = pm.environment.get("ACCESS_TOKEN");
const accessTokenExpires = pm.environment.get("ACCESS_TOKEN_EXPIRES");

// 过期处理
if (!accessToken || (accessTokenExpires && new Date(accessTokenExpires) <= new Date())) {
    generateAccessToken();
}
```



## 设置token

```js
var appToken = pm.environment.get('APP_TOKEN');
var accessToken = pm.environment.get('ACCESS_TOKEN');
pm.request.headers.upsert({ key: "appToken", value: appToken })
pm.request.headers.upsert({ key: "accessToken", value: accessToken })
```



## 后置处理

```js
// console.log("ret:"+Object.prototype.toString.call(ret))
if("[object Object]" != Object.prototype.toString.call(ret)){
  return;
}

var ret = pm.response.json()
if(!ret) {
  return;
}

var header = pm.response.headers.get("Content-Type")
if(!header.includes("application/json")){
  console.log("Content-Type:"+header)
  return;
}

if("errorCode" in ret ){
  if(ret.errorCode == 40100 || ret.errorCode == 40101 ||  ret.errorCode == 40102 ||ret.errorCode == 40103) {
    console.log("清理 APP_TOKEN & ACCESS_TOKEN")
    pm.environment.set("ACCESS_TOKEN", '');
    pm.environment.set('APP_TOKEN', '');
    pm.environment.set('ACCESS_TOKEN_EXPIRES', '');
    pm.environment.set('APP_TOKEN_EXPIRES', '');
  }
}

```

